<?xml version="1.0" encoding="UTF-8"?>
<configuration scan="true" scanPeriod="30 seconds">

    <!-- 引入Spring Boot默认配置 -->
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>

    <!-- 从application.properties读取配置 -->
    <springProperty scope="context" name="APP_NAME" source="spring.application.name" defaultValue="unknown-app"/>
    <springProperty scope="context" name="NODE_ID" source="node.id" defaultValue="unknown-node"/>
    <springProperty scope="context" name="SERVER_PORT" source="server.port" defaultValue="8080"/>
    <springProperty scope="context" name="LOG_LEVEL" source="logging.level.root" defaultValue="INFO"/>
    <springProperty scope="context" name="LOGSTASH_ENABLED" source="logging.logstash.enabled" defaultValue="false"/>
    <springProperty scope="context" name="LOGSTASH_HOST" source="logging.logstash.host" defaultValue="localhost"/>
    <springProperty scope="context" name="LOGSTASH_PORT" source="logging.logstash.port" defaultValue="5000"/>

    <!-- 定义变量 -->
    <property name="LOG_PATH" value="logs"/>
    <property name="LOG_FILE" value="${LOG_PATH}/${APP_NAME}-${NODE_ID}.log"/>
    <property name="CONSOLE_PATTERN" value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} [${NODE_ID}:${SERVER_PORT}] - %msg%n"/>

    <!-- 1. 控制台输出 -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${CONSOLE_PATTERN}</pattern>
            <charset>utf8</charset>
        </encoder>
    </appender>

    <!-- 2. 文件输出 - 支持时间和大小滚动 -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_FILE}</file>
        <encoder>
            <pattern>${CONSOLE_PATTERN}</pattern>
            <charset>utf8</charset>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <!-- 正确的模式：同时包含日期和索引 -->
            <fileNamePattern>${LOG_PATH}/archive/${APP_NAME}-${NODE_ID}.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <!-- 每个文件最大大小 -->
            <maxFileSize>10MB</maxFileSize>
            <!-- 保留最近30天的日志 -->
            <maxHistory>30</maxHistory>
            <!-- 总大小限制 -->
            <totalSizeCap>1GB</totalSizeCap>
            <!-- 启动时清理历史 -->
            <cleanHistoryOnStart>true</cleanHistoryOnStart>
        </rollingPolicy>
    </appender>

    <!-- 3. 错误日志 - 只按时间滚动 -->
    <appender name="ERROR_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_PATH}/error-${APP_NAME}-${NODE_ID}.log</file>
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>ERROR</level>
        </filter>
        <encoder>
            <pattern>${CONSOLE_PATTERN}</pattern>
            <charset>utf8</charset>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <!-- 错误日志只按日期滚动，不使用%i -->
            <fileNamePattern>${LOG_PATH}/archive/error-${APP_NAME}-${NODE_ID}.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>90</maxHistory>
        </rollingPolicy>
    </appender>

    <!-- 4. Logstash输出 - 根据环境启用 -->
    <springProfile name="local, test, prod">
        <!-- 临时简化：在现有配置基础上修改 -->
        <appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
            <destination>localhost:5000</destination>
            <encoder class="net.logstash.logback.encoder.LogstashEncoder">
                <!-- 大幅减少自定义字段 -->
                <customFields>{
                    "app": "${APP_NAME}",
                    "node": "${NODE_ID}",
                    "port": ${SERVER_PORT}
                    }</customFields>

                <!-- 排除冗余字段 -->
                <includeMdc>false</includeMdc>
                <includeContext>false</includeContext>

                <!-- 简化字段命名 -->
                <fieldNames>
                    <timestamp>@timestamp</timestamp>
                    <version>[ignore]</version>
                    <message>message</message>
                    <logger>logger</logger>
                    <thread>thread</thread>
                    <level>level</level>
                    <levelValue>[ignore]</levelValue>
                    <caller>[ignore]</caller>
                </fieldNames>
            </encoder>
        </appender>
    </springProfile>

    <!-- 根日志配置 -->
    <root level="${LOG_LEVEL}">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="FILE"/>
        <appender-ref ref="ERROR_FILE"/>
        <!-- 根据环境启用Logstash -->
        <springProfile name="local, test, prod">
            <appender-ref ref="LOGSTASH"/>
        </springProfile>
    </root>

    <!-- 应用特定日志配置 -->
    <logger name="com.example" level="info" additivity="false">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="FILE"/>
        <springProfile name="local, test, prod">
            <appender-ref ref="LOGSTASH"/>
        </springProfile>
    </logger>

    <!-- 第三方库日志级别 -->
    <logger name="org.springframework" level="INFO"/>
    <logger name="org.hibernate" level="WARN"/>
    <logger name="com.alibaba.nacos" level="INFO"/>

</configuration>
